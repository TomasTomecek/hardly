---
# This playbook is running tests inside Zuul
- name: Run hardly tests
  hosts: all
  vars:
    # Zuul base job redefines project_dir
    project_dir: "{{ playbook_dir }}/.."
  tasks:
    - name: Install podman
      dnf:
        name:
          - podman
        state: present
      become: true
    - name: Build the test image
      command: "make build-test-image"
      args:
        chdir: "{{ project_dir }}"
      environment:
        COLOR: "no"
        SOURCE_BRANCH: "{{ zuul.branch }}"
    - name: Run tests within a container
      command: "make check-in-container"
      args:
        chdir: "{{ project_dir }}"
      environment:
        COLOR: "no"
        SOURCE_BRANCH: "{{ zuul.branch }}"
